# cnn_moji
- 作成者：Funamoto
- リリース日：2018.9.10
- 更新日：2018.9.10

# 概要
画像生成→学習→予測の３ステップ
1. 学習用のjpg画像を作成。ひらがな、カタカナ、漢字、数字、アルファベットごとに作る。
生成した画像のサンプルはサンプル画像の中にある。このサンプルはDを印字した画像である。
生成する画像は、一文字につき、くっきりとした画像(Ｄ_0_W3.ttc.jpg)、ぼかした画像（Ｄ_0_W3.ttc_noise2.jpg）、背景を少し暗くなるようにノイズを入れた画像（Ｄ_0_W3.ttc_noise.jpg）の３種類を用意した。
学習用画像は、１００ピクセルのサイズに合わせて加工しているので、画像サイズを変更すると、うまく画像が生成されない。
2. ひらがな、カタカナ、漢字、数字、アルファベットごとに学習。モデルをmodel,ウェイトをweightディレクトリへ保存。
3. ２のウェイトとモデルをロードして、画像を予測。予測する画像はjpg形式を想定。test_higashi2が仮に作成した予測用画像ファイル。


# 動作環境
- Python 3.6.5
- OpenCV 3.4.0
- numpy 1.14.2
- Pillow 2.0.0
- Scikit learn 0.19.1
- Keras  2.2.2


# ディレクトリ構成内容の説明
- `README.md`：このファイルです

- `kanji_images`：2144字の漢字画像すべてがこの中に生成される。このフォルダ内のcreate_1moji_images.pyのファイルを実行することで漢字の画像生成ができる。
- `hira_images`：ひらがなの画像すべてがこの中に生成される。このフォルダ内のcreate_1moji_images.pyのファイルを実行することでひらがなの画像生成ができる。
- `kata_images`：カタカナの画像すべてがこの中に生成される。このフォルダ内のcreate_1moji_images.pyのファイルを実行することでカタカナの画像生成ができる。
- `num_images`：数字の画像すべてがこの中に生成される。このフォルダ内のcreate_1moji_images.pyのファイルを実行することで数字の画像生成ができる。
- `alfa_images`：アルファベットの画像すべてがこの中に生成される。このフォルダ内のcreate_1moji_images.pyのファイルを実行することでアルファベットの画像生成ができる。
- `others`：ひらがな、カタカナ、漢字、数字、アルファベットの画像がすべてまとめて保存されているディレクトリ。学習の際に、ある特定の文字（東とか、アとか）とその他（東以外のすべての文字、ア以外のすべての文字）を分けてラベルづけしないといけない為、その他に該当するすべての文字の画像をこのディレクトリに保存している。
- `create_1moji_images.py`：概要１を実行するファイル。上記の各ディレクトリごとに配置されており、それぞれの文字画像を生成する。今回はある特定の文字（２３００文字）とその他（２３００文字）を仕分けることが目的なので、ある特定の文字の画像を生成するためのプログラム。
- `create_others_images.py`：概要１を実行。その他に該当する画像を生成する。ひらがな、カタカナ、漢字、数字、アルファベットの画像をすべてothersというフォルダにまとめて保存する。特定の文字とその他の画像の枚数を２３００文字で揃えて学習することを前提としているので、ひらがな、カタカナ、漢字、数字、アルファベットの中からランダムで２３００文字を選んで、その文字の画像をothersに保存する。
- `train_hira.py`：概要の2を実行するファイル。hira_imagesの中にあるjpg画像とothersの中にあるjpg画像を読み込み、ある特定のひらがなとothersを分類する学習モデル。特定のひらがなを１、それ以外のすべての文字を０としてラベルづけを行っている。学習後のモデルはmodelディレクトリへ、weightはweightディレクトリへ保存する。
- `train_kata.py`：概要の2を実行するファイル。kata_imagesの中にあるjpg画像とothersの中にあるjpg画像を読み込み、ある特定のカタカナとothersを分類する学習モデル。特定のカタカナを１、それ以外のすべての文字を０としてラベルづけを行っている。学習後のモデルはmodelディレクトリへ、weightはweightディレクトリへ保存する。
- `train_alfa.py`：概要の2を実行するファイル。alfa_imagesの中にあるjpg画像とothersの中にあるjpg画像を読み込み、ある特定のアルファベットとothersを分類する学習モデル。特定のアルファベットを１、それ以外のすべての文字を０としてラベルづけを行っている。学習後のモデルはmodelディレクトリへ、weightはweightディレクトリへ保存する。
- `train_kanji.py`：概要の2を実行するファイル。kanji_imagesの中にあるjpg画像とothersの中にあるjpg画像を読み込み、ある特定の漢字とothersを分類する学習モデル。特定の漢字を１、それ以外のすべての文字を０としてラベルづけを行っている。学習後のモデルはmodelディレクトリへ、weightはweightディレクトリへ保存する。
- `train_num.py`：概要の2を実行するファイル。num_imagesの中にあるjpg画像とothersの中にあるjpg画像を読み込み、ある特定の数字とothersを分類する学習モデル。特定の数字を１、それ以外のすべての文字を０としてラベルづけを行っている。学習後のモデルはmodelディレクトリへ、weightはweightディレクトリへ保存する。
- `model`：train_hira.py , train_kata.py , train_alfa.py , train_kanji.py , train_num.pyで学習したモデルがこのフォルダにまとめて保存される。
- `weight`：train_hira.py , train_kata.py , train_alfa.py , train_kanji.py , train_num.pyで学習したweightがこのフォルダにまとめて保存される。
- `load_predict_moji.py`：概要３を実行する。１：予測したい画像フォルダを入力する（仮としてtest_higashi2フォルダを設置）　２：そこから画像を一枚ずつ取り出し、画像一枚ごとにmodelとweight内にある全てのモデルとウェイトを使って予測する。　３：一番確率が高かった文字が予測したい画像に書かれている文字として出力する。４：１のフォルダ内の次の画像を取り出し２と３を行う。１のフォルダ内の画像がなくなるまでループ。
- `test_higashi2`：溝口さんがSSDから切り取ってくれた画像が格納されている。load_predict_moji.pyの予測用のファイル。
- `kanji_list.py`：２１４４文字の漢字のリストを作るスクリプト。特に実行する必要はないので放置。



# 実行


```
作業ディレクトリへ移動する
$ cd cnn_moji
$ cd kanji_images
or
$ cd hira_images
or
$ cd kata_images
or
$ cd num_images
or
$ cd alfa_images

概要１のを実行。これで画像生成一発
$ python3 create_1moji_images.py


概要２を実行。
$ cd ..
$ python3 train_hira.py
or
$ python3 train_kata.py
or
$ python3 train_alfa.py
or
$ python3 train_kanji.py
or
$ python3 train_num.py


概要３を実行。
$ python3 load_predict_moji.py

```



# パラメーターの設定

## train系のパラメータセッティング

```
バッチサイズ
batch_size = ...

エポック数
epoch = ...

画像サイズ
image_size = 100

テスト用の画像
test_file = ...

学習を何回か繰り返したいとき
repeat = ...(通常は１に設定)

その他は特にいじる必要なし

```

## create_1moji_imagesのセッティング
```
何枚画像生成するか
nb * ３枚作る
トータル３０００枚作りたいならnb = 1000
nb = ...

画像サイズ
image_size = 100

その他は特にいじる必要なし

画像の拡大率も以下の範囲内で設定しているのは、SSDで切り取った後の画像に近いサイズだから。
あまりいじらない方が良いかと
size_min = 130
size_max = 140

```

## create_others_imagesのセッティング
```
全文字とはallmoji_listの変数に格納されているリストの要素の数
allmoji_list = random.sample(allmoji_list, 1000)
ここで全ての文字から何文字ランダムで取り出すか指定できる


その全文字数 * 3 * nb  枚作る
nb = ...

その他はいじる必要なし

```



## load_predict_mojiのパラメータセッティング

```
# 予測したいjpg画像が格納されているフォルダを指定する
test_file = 'test_higashi2'

#jpg画像をリサイズするサイズ指定
size = 32
```



# 更新履歴
2018.9.10 - リリース
